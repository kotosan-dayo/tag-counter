<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Webカウンター</title>
<style>
:root{--bg:#f5f5f7;--card-bg:#fff;--border:#e5e5ea;--accent:#007aff;--danger:#ff3b30;--radius:14px;--shadow:0 4px 12px rgba(0,0,0,0.08);}
body{margin:0;padding:24px;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,sans-serif;background:var(--bg);color:#111;transition:background-color 0.3s,color 0.3s;}
body.dark{--bg:#1c1c1e;--card-bg:#2c2c2e;--border:#3a3a3c;--accent:#0a84ff;--danger:#ff453a;color:#f5f5f7;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
h1{font-size:1.5rem;font-weight:600;margin:0;}
.settings-btn{background:transparent;border:none;color:var(--accent);font-size:1.2rem;cursor:pointer;transition:color 0.3s;}
.counters{display:grid;gap:16px;overflow-x:hidden;}
.counter-card{background:var(--card-bg);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;display:flex;flex-direction:column;gap:12px;transition:transform 0.15s ease,background-color 0.3s,color 0.3s;}
.counter-card:active{transform:scale(0.98);}
.counter-header{display:flex;justify-content:space-between;align-items:center;}
.counter-label{font-size:1.2rem;font-weight:600;outline:none;}
.counter-value{font-size:2rem;font-weight:700;text-align:center;font-variant-numeric:tabular-nums;width:100%;max-width:100%;background:var(--card-bg);color:inherit;border:none;border-radius:var(--radius);text-align:center;transition:transform 0.2s ease;}
.counter-actions{display:flex;justify-content:center;gap:12px;}
.counter-actions button{padding:10px 16px;border:none;border-radius:var(--radius);font-size:1rem;cursor:pointer;transition:background 0.2s;}
.plus{background:var(--accent);color:#fff;}
.minus{background:var(--border);}
.reset{background:var(--danger);color:#fff;}
.fullscreen-btn{background:transparent;border:none;color:var(--accent);font-size:1.2rem;cursor:pointer;}
.delete-btn{background:transparent;border:none;color:var(--danger);font-size:1.2rem;cursor:pointer;}
.add-form{margin:20px 0;display:flex;gap:10px;justify-content:center;}
.add-form input{flex:1;padding:10px;border:1px solid var(--border);border-radius:var(--radius);font-size:1rem;background:var(--card-bg);color:inherit;max-width:100%;transition:background-color 0.3s,color 0.3s;}
.add-form button{padding:10px 16px;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;font-size:1rem;cursor:pointer;transition:background 0.3s;}

/* 全画面 */
.fullscreen{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;z-index:1000;color:#fff;overflow:hidden;animation:fadeIn 0.3s ease;}
.fullscreen-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;font-size:1.2rem;}
.close-full{background:var(--danger);border:none;color:#fff;font-size:14px;border-radius:var(--radius);padding:8px 14px;cursor:pointer;}
.fullscreen-center{flex:1;display:flex;align-items:center;justify-content:center;}
.fullscreen-count{font-size:clamp(10rem,30vw,30rem);font-weight:700;font-variant-numeric:tabular-nums;animation:pop 0.2s;text-align:center;line-height:1;}
.fullscreen-btns{display:flex;justify-content:center;gap:20px;padding:20px;}
.fullscreen-btns button{padding:16px 22px;border-radius:var(--radius);border:none;font-size:22px;cursor:pointer;}
.fullscreen-btns .accent{background:var(--accent);color:#fff;}
.fullscreen-btns .danger{background:var(--danger);color:#fff;}

/* 設定モーダル */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1500;animation:fadeIn 0.3s ease;}
.modal-content{background:var(--card-bg);color:inherit;padding:20px;border-radius:var(--radius);width:90%;max-width:420px;transition:background-color 0.3s,color 0.3s;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.modal-header h2{margin:0;font-size:1.2rem;font-weight:600;}
.modal-header .close-btn{background:transparent;border:none;font-size:1.5rem;cursor:pointer;color:inherit;}
.settings-section{margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.settings-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.settings-section h3{font-size:1rem;margin:0 0 8px;font-weight:600;}
.settings-section button{display:block;margin:6px 0;padding:8px 12px;border-radius:var(--radius);border:none;background:var(--accent);color:#fff;cursor:pointer;width:100%;text-align:center;}

@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
@keyframes pop{from{transform:scale(1.15);}to{transform:scale(1);}}
</style>
</head>
<body>
<header>
  <h1>Webカウンター</h1>
  <button class="settings-btn" onclick="openSettings()" id="settingsBtn">⚙</button>
</header>

<div class="add-form">
  <input id="newLabel" type="text" placeholder="カウンター名を入力">
  <button onclick="addCounter()">追加</button>
</div>

<div class="counters" id="counters"></div>

<div id="fullscreenContainer" class="fullscreen" style="display:none;"></div>

<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>設定</h2>
      <button class="close-btn" onclick="closeSettings()">✕</button>
    </div>
    <div class="settings-section">
      <h3>表示設定</h3>
      <label><input type="checkbox" id="darkModeToggle"> ダークモード</label>
    </div>
    <div class="settings-section">
      <h3>データ管理</h3>
      <button onclick="saveData()">データを書き出し</button>
      <input type="file" id="loadFile" style="display:none" onchange="loadData(event)">
      <button onclick="document.getElementById('loadFile').click()">データを読み込み</button>
    </div>
  </div>
</div>

<script>
let state=[],idCounter=0;
const countersEl=document.getElementById("counters");
const fullscreenContainer=document.getElementById("fullscreenContainer");
const settingsBtn=document.getElementById("settingsBtn");
const darkModeToggle=document.getElementById("darkModeToggle");
let actionInProgress = {}; 

darkModeToggle.addEventListener("change",e=>{document.body.classList.toggle("dark",e.target.checked);});

// 連打で画面ズーム防止
let lastTap=0;
document.addEventListener('touchend',function(e){
  const currentTime=new Date().getTime();
  const tapLength=currentTime-lastTap;
  if(tapLength<300 && tapLength>0){ e.preventDefault(); }
  lastTap=currentTime;
}, false);

function renderCounters(){
  countersEl.innerHTML="";
  state.forEach(item=>{
    const card=document.createElement("div");
    card.className="counter-card";
    card.innerHTML=`
      <div class="counter-header">
        <div class="counter-label" contenteditable="true" oninput="rename('${item.id}',this.innerText)">${item.label}</div>
        <div>
          <button class="fullscreen-btn" onclick="openFullscreen('${item.id}')">⤢</button>
          <button class="delete-btn" onclick="deleteCounter('${item.id}')">✕</button>
        </div>
      </div>
      <input type="number" class="counter-value" value="${item.count}" data-id="${item.id}" oninput="keyboardChange('${item.id}',this)">
      <div class="counter-actions">
        <button class="minus" data-id="${item.id}">−</button>
        <button class="plus" data-id="${item.id}">＋</button>
        <button class="reset" data-id="${item.id}">リセット</button>
      </div>
    `;
    countersEl.appendChild(card);
    const plusBtn=card.querySelector(".plus");
    const minusBtn=card.querySelector(".minus");
    const resetBtn=card.querySelector(".reset");
    ["click","touchstart"].forEach(ev=>{
      plusBtn.addEventListener(ev,()=>updateCount(item.id,1));
      minusBtn.addEventListener(ev,()=>updateCount(item.id,-1));
      resetBtn.addEventListener(ev,()=>updateCount(item.id,0,true));
    });
  });
}

function keyboardChange(id,inputEl){
  let val = inputEl.value.replace(/[^0-9]/g,'');
  inputEl.value = val;
  const c = state.find(x=>x.id===id);
  c.count = parseInt(val)||0;
  updateFullscreenCount(id);
}

function updateCount(id, delta, resetFlag=false){
  if(actionInProgress[id]) return;
  actionInProgress[id]=true;
  const c = state.find(x=>x.id===id);
  if(resetFlag){c.count=0;} else {c.count+=delta;}
  const inputEl=document.querySelector(`.counter-value[data-id='${id}']`);
  if(inputEl) inputEl.value=c.count;
  const fsCount=document.getElementById("fs-count");
  if(fsCount){fsCount.textContent=c.count; fsCount.style.animation="none"; fsCount.offsetHeight; fsCount.style.animation="pop 0.2s";}
  setTimeout(()=>{actionInProgress[id]=false;},100);
}

function addCounter(){
  const input=document.getElementById("newLabel");
  let label=input.value.trim()||"無名のカウンター";
  state.push({id:String(idCounter++),label,count:0});
  input.value="";
  renderCounters();
}

function deleteCounter(id){state=state.filter(c=>c.id!==id);renderCounters();}
function rename(id,name){const c=state.find(x=>x.id===id);if(c)c.label=name.trim()||"無名のカウンター";}

function openFullscreen(id){
  const item=state.find(c=>c.id===id);
  fullscreenContainer.style.display="flex";
  fullscreenContainer.innerHTML=`
    <div class="fullscreen-header">
      <div>${item.label}</div>
      <button class="close-full" onclick="closeFullscreen()">閉じる</button>
    </div>
    <div class="fullscreen-center">
      <div id="fs-count" class="fullscreen-count">${item.count}</div>
    </div>
    <div class="fullscreen-btns">
      <button class="minus">−</button>
      <button class="accent">＋</button>
      <button class="danger">リセット</button>
    </div>
  `;
  settingsBtn.style.display="none";
  const fsMinus=fullscreenContainer.querySelector(".minus");
  const fsPlus=fullscreenContainer.querySelector(".accent");
  const fsReset=fullscreenContainer.querySelector(".danger");
  ["click","touchstart"].forEach(ev=>{
    fsMinus.addEventListener(ev,()=>updateCount(item.id,-1));
    fsPlus.addEventListener(ev,()=>updateCount(item.id,1));
    fsReset.addEventListener(ev,()=>updateCount(item.id,0,true));
  });
}

function closeFullscreen(){fullscreenContainer.style.display="none";settingsBtn.style.display="inline-block";}
function updateFullscreenCount(id){
  const item=state.find(c=>c.id===id);
  const fsCount=document.getElementById("fs-count");
  if(fsCount){fsCount.textContent=item.count;fsCount.style.animation="none";fsCount.offsetHeight;fsCount.style.animation="pop 0.2s";}
}

// 設定モーダル
function openSettings(){document.getElementById("settingsModal").style.display="flex";}
function closeSettings(){document.getElementById("settingsModal").style.display="none";}

// データ管理
function saveData(){
  const blob=new Blob([JSON.stringify(state)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="counters.json";a.click();
  alert("データ保存用ファイルをダウンロードします\n読み込む際に必要になります。無くさないようにしてください");
}
function loadData(e){
  const file=e.target.files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=function(ev){
    state=JSON.parse(ev.target.result);
    renderCounters();
    alert("読み込みが完了しました！");
  }
  r.readAsText(file);
}

renderCounters();
</script>
</body>
</html>