<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Webカウンター</title>
<style>
:root {
  --bg:#f5f5f7;--card-bg:#fff;--border:#e5e5ea;
  --accent:#007aff;--danger:#ff3b30;--text:#000;
}
body.dark {--bg:#1c1c1e;--card-bg:#2c2c2e;--border:#3a3a3c;--accent:#0a84ff;--danger:#ff453a;--text:#fff;}
body {
  background:var(--bg);font-family:sans-serif;
  margin:0;padding:1rem;transition:background 0.3s;
}
header {
  display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;
}
button,input,label {
  padding:0.5rem 1rem;font-size:1rem;
  border:1px solid var(--border);border-radius:8px;
}
button {background:var(--accent);color:#fff;cursor:pointer;}
button.danger {background:var(--danger);}
button.secondary {background:var(--card-bg);color:var(--text);}
#counters {display:grid;gap:1rem;}
.counter {
  background:var(--card-bg);border:1px solid var(--border);
  border-radius:12px;padding:1rem;
}
.counter h2 {margin:0 0 0.5rem 0;}
.controls {
  display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.5rem;
}
.auto-controls {
  margin-top:0.5rem;display:flex;flex-wrap:wrap;gap:0.5rem;
}
</style>
</head>
<body>
<header>
  <input id="newLabel" placeholder="新しいカウンター名">
  <button onclick="addCounter()">＋カウンター追加</button>
  <button class="secondary" onclick="toggleDark()">🌙/☀️</button>
  <button class="secondary" onclick="toggleFullscreen()">⛶ 全画面</button>
  <button class="secondary" onclick="saveData()">💾 保存</button>
  <input type="file" id="loadFile" style="display:none" onchange="loadData(event)">
  <button class="secondary" onclick="document.getElementById('loadFile').click()">📂 読込</button>
</header>

<div id="counters"></div>

<script>
let state=[];
let idCounter=0;
let timers={};

// カウンター描画
function renderCounters(){
  const c=document.getElementById("counters");
  c.innerHTML="";
  state.forEach(item=>{
    const div=document.createElement("div");
    div.className="counter";
    div.innerHTML=`
      <h2 contenteditable="true" onblur="rename('${item.id}',this.innerText)">${item.label}</h2>
      <p style="font-size:2rem;">${item.count}</p>
      <div class="controls">
        <button onclick="updateCount('${item.id}',1)">＋1</button>
        <button onclick="updateCount('${item.id}',-1)">－1</button>
        <button onclick="resetCount('${item.id}')" class="secondary">リセット</button>
        <button onclick="deleteCounter('${item.id}')" class="danger">削除</button>
      </div>
      <div class="auto-controls">
        <label>間隔(秒):<input type="number" step="0.1" min="0.1" id="interval-${item.id}" value="${item.interval||1}" style="width:5em;"></label>
        <label>増加値:<input type="number" step="0.1" id="step-${item.id}" value="${item.step||1}" style="width:4em;"></label>
        <button onclick="startAuto('${item.id}')">▶開始</button>
        <button onclick="stopAuto('${item.id}')" class="secondary">■停止</button>
      </div>
    `;
    c.appendChild(div);
  });
  saveLocal();
}

// カウンター操作
function updateCount(id,delta){
  let item=state.find(x=>x.id===id);
  if(!item)return;
  item.count+=delta;
  renderCounters();
}
function resetCount(id){
  let item=state.find(x=>x.id===id);
  if(!item)return;
  if(confirm("本当にリセットしますか？")){
    item.count=0;renderCounters();
  }
}
function addCounter(){
  const input=document.getElementById("newLabel");
  let label=input.value.trim()||"無名のカウンター";
  state.push({id:String(idCounter++),label,count:0,interval:1,step:1});
  input.value="";
  renderCounters();
}
function deleteCounter(id){
  state=state.filter(x=>x.id!==id);
  stopAuto(id);
  renderCounters();
}
function rename(id,name){
  let item=state.find(x=>x.id===id);
  if(item)item.label=name.trim()||item.label;
  saveLocal();
}

// 自動カウント
function startAuto(id){
  stopAuto(id);
  let interval=parseFloat(document.getElementById("interval-"+id).value)||1;
  let step=parseFloat(document.getElementById("step-"+id).value)||1;
  timers[id]=setInterval(()=>updateCount(id,step), interval*1000);
  let item=state.find(x=>x.id===id);
  if(item){item.interval=interval;item.step=step;}
  saveLocal();
}
function stopAuto(id){
  if(timers[id]){clearInterval(timers[id]);delete timers[id];}
}

// データ保存/読み込み
function saveData(){
  const blob=new Blob([JSON.stringify(state)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="counters.json";a.click();
  URL.revokeObjectURL(url);
}
function loadData(e){
  const file=e.target.files[0]; if(!file)return;
  const r=new FileReader();
  r.onload=function(ev){
    try{
      const parsed=JSON.parse(ev.target.result);
      if(Array.isArray(parsed)){state=parsed;renderCounters();}
      else alert("データ形式が正しくありません");
    }catch(err){alert("読み込みエラー:"+err.message);}
  }
  r.readAsText(file);
}

// localStorage永続化
function saveLocal(){localStorage.setItem("countersData",JSON.stringify(state));}
function loadLocal(){const saved=localStorage.getItem("countersData");if(saved){state=JSON.parse(saved);}}

// 便利機能
function toggleDark(){document.body.classList.toggle("dark");}
function toggleFullscreen(){
  if(!document.fullscreenElement)document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

// 初期化
loadLocal();
renderCounters();
</script>
</body>
</html>